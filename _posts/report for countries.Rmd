---
title: "Estimated change in pneumonia mortality associated with the introduction of PCV10 In Brazil"
author: "PAHO/Yale analysis team"
date: "September 13, 2018"
output:
  github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE, warnings = FALSE)
```

```{r echo=FALSE}
library(knitr)
d1<-readRDS('C:/Users/dmw63/Documents/GitHub/synthetic-control-poisson/Results_Brazil_2018-09-13-213318/BrazilStack estimates.rds')
```

##Comparison of observed and expected number of cases

```{r echo=FALSE,message = FALSE, warning = FALSE}

#Plot aggregated predictions.
plotPredAgg <- function(ann_pred_quantiles,  time_points, year_def='cal_year' ,post_period,  outcome_plot, title = NULL, sensitivity_pred_quantiles = NULL, sensitivity_title = 'Sensitivity Plots', plot_sensitivity = FALSE) {
  library(lubridate)
  library(ggplot2)
    intervention_date<-d1$post_period[1]

    if(year_def=='epi_year'){
    month.int<-month(intervention_date)
    year.int<-year(intervention_date)
    epiyr.int<-year.int
    epiyr.int[month.int<=6]<-year.int[month.int<=6]<-1
    year.intervention<- which( as.numeric(substr(as.character(ann_pred_quantiles$year),1,4))==epiyr.int) - 0.5
  }else{
  year.intervention<-year(intervention_date )+0.5
}
    pred_plot <- ggplot() + 
        geom_ribbon(data=ann_pred_quantiles, aes( x=as.numeric(year), ymin=ann_pred_quantiles$'2.5%', ymax=ann_pred_quantiles$'97.5%'), alpha=0.5, fill='lightgray')+
      geom_point(data = ann_pred_quantiles, aes_string(x = as.numeric(ann_pred_quantiles$year), y = ann_pred_quantiles$obs)) +
      geom_line(data = ann_pred_quantiles, aes_string(x = as.numeric(ann_pred_quantiles$year), y = ann_pred_quantiles$'50%'), linetype = 'solid', color = 'black') + 
      labs(x = 'Year', y = 'Number of Cases') + 
      geom_vline(xintercept = year.intervention, linetype='dashed', color='gray')+
      ylim(0, max(ann_pred_quantiles$'97.5%')) +
      ggtitle(title) + 
      theme_bw() +
      scale_x_continuous(breaks = 1:nrow(ann_pred_quantiles), labels = levels(ann_pred_quantiles$year)) + 
      theme(axis.line = element_line(colour = "black"),
            axis.text.x=element_text(angle = -45, hjust = 0),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.border = element_blank(),
            panel.background = element_blank()) +
      theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
    return(pred_plot)
}
plot1<-lapply(d1$ann_pred_quantiles_stack, plotPredAgg,  post_period=d1$post_period, time_points=d1$time_points)
plot1[[10]]
```



##Cumulative cases averted among children <12months

```{r echo=FALSE, fig.width=6, fig.height=4}
cusum.prevented<-d1$cumsum_prevented_stack
pre.period<- cusum.prevented[,1,10] == cusum.prevented[,3,10] & cusum.prevented[,1,10]==0
matplot(cusum.prevented[!pre.period,,10], type='l', col='black', lty=c(2,1,2), bty='l', xlab= 'Months since introduction of PCV',ylab='Cases averted')
abline(h=0, lty=3)
```

##Esimated decline by age group

```{r echo=FALSE}
kable(d1$rr_mean_stack_intervals)
```